<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Patons Rock Villas – Today & Tomorrow</title>
<style>
body { background:#000; color:#fff; font-family:"Segoe UI",Arial,sans-serif; margin:0; text-align:center; }
.welcome-banner {
  background:linear-gradient(135deg,#004466,#0077b6);
  padding:20px; border-radius:10px; margin:20px auto;
  max-width:800px; box-shadow:0 4px 12px rgba(0,0,0,0.5);
}
.welcome-banner h1 {margin:0 0 8px;font-size:1.8em;text-shadow:0 0 10px #FFD700;}
#current-date {color:#FFD700;font-size:1.1em;}
.calendar-grid {
  display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:25px; max-width:1100px; margin:30px auto;
}
.calendar-container {
  background:#222; border-radius:15px; padding:15px;
  box-shadow:0 6px 14px rgba(0,0,0,0.6);
}
.calendar-container h2 {color:#00b4d8;margin-top:0;}
ul {list-style:none;padding:0;margin:0;}
li {padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.1);}
.today {color:#FFD700;}   /* gold for today */
.tomorrow {color:#aaa;}   /* silver for tomorrow */
.debug {
  background:#111; border-top:1px solid #333; margin-top:30px;
  padding:10px; font-size:0.9em; color:#aaa;
}
</style>
</head>
<body>
<div class="welcome-banner">
  <h1>Welcome to Patons Rock Beach Villas</h1>
  <p>For assistance please call <strong>027 356 3551</strong>.</p>
  <div id="current-date"></div>
</div>

<h2>Today & Tomorrow</h2>
<div class="calendar-grid" id="villaGrid">
  <div class="calendar-container"><h2>Villa 1</h2><ul id="villa1"></ul></div>
  <div class="calendar-container"><h2>Villa 2</h2><ul id="villa2"></ul></div>
  <div class="calendar-container"><h2>Villa 3</h2><ul id="villa3"></ul></div>
  <div class="calendar-container"><h2>Villa 4</h2><ul id="villa4"></ul></div>
</div>

<div class="debug" id="debug">Loading...</div>

<script>
const villas = {
  villa1: "https://api.beds24.com/ical/bookings.ics?roomid=318483&token=ea7b37ea5fc562875d2a5196a1a77ed8",
  villa2: "https://api.beds24.com/ical/bookings.ics?roomid=318484&token=619894678ee80521412a314854aba411",
  villa3: "https://api.beds24.com/ical/bookings.ics?roomid=318485&token=0dc12d488822f3fb0487273a4d933c84",
  villa4: "https://api.beds24.com/ical/bookings.ics?roomid=318486&token=9634a496cdf402a5c88b5685866a00e8"
};

// Public proxy for CORS bypass
const proxy = "https://api.allorigins.win/raw?url=";

function getNZDateYMD(offset = 0) {
  const now = new Date();
  const date = new Date(now.getTime() + offset * 86400000);
  return date.toLocaleDateString('en-CA', {timeZone: 'Pacific/Auckland'});
}

function getFormattedDate(ymd) {
  const date = new Date(ymd + 'T00:00:00');
  return date.toLocaleDateString("en-NZ", {day: "numeric", month: "short", timeZone: "Pacific/Auckland"});
}

function extractName(summary, description) {
  let name = summary.trim();
  if (name.includes(' - ')) {
    name = name.split(' - ').pop().trim();
  }
  if (!name || name === 'Booking' || name.length < 2) {
    const match = description.match(/Name:\s*(.+?)(?=\n|$)/i);
    if (match) name = match[1].trim();
    else name = 'Guest';
  }
  return name;
}

function getEventDates(block) {
  const startMatch = block.match(/DTSTART(?:;VALUE=DATE|;TZID=Pacific\/Auckland)?:(\d{8})(?:T\d{6}Z?)?/);
  const endMatch = block.match(/DTEND(?:;VALUE=DATE|;TZID=Pacific\/Auckland)?:(\d{8})(?:T\d{6}Z?)?/);
  if (!startMatch || !endMatch) return null;
  const startYMD = startMatch[1].substring(0,4) + '-' + startMatch[1].substring(4,2) + '-' + startMatch[1].substring(6,2);
  const endYMD = endMatch[1].substring(0,4) + '-' + endMatch[1].substring(4,2) + '-' + endMatch[1].substring(6,2);
  const summaryMatch = block.match(/SUMMARY:(.+?)(?=\n[A-Z]|\n$)/);
  const summary = summaryMatch ? summaryMatch[1].trim().replace(/\\,/g, ',') : 'Booking';
  const descMatch = block.match(/DESCRIPTION:(.+?)(?=\n[A-Z]|\n$)/s);
  const description = descMatch ? descMatch[1].replace(/\\n/g, ' ').replace(/\\,/g, ',').trim() : '';
  return {startYMD, endYMD, summary, description};
}

async function loadVilla(id, url) {
  const list = document.getElementById(id);
  list.innerHTML = "<li>Loading…</li>";
  try {
    const res = await fetch(proxy + encodeURIComponent(url));
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const ics = await res.text();
    const blocks = ics.split("BEGIN:VEVENT").slice(1);
    const todayYMD = getNZDateYMD(0);
    const tomorrowYMD = getNZDateYMD(1);
    const todayFormatted = getFormattedDate(todayYMD);
    const tomorrowFormatted = getFormattedDate(tomorrowYMD);
    const showBookings = [];

    blocks.forEach(block => {
      const event = getEventDates(block);
      if (!event) return;
      const name = extractName(event.summary, event.description);
      const descHtml = event.description ? `<br><small>${event.description}</small>` : '';

      // Arrival today
      if (event.startYMD === todayYMD) {
        showBookings.push(`<li class="today">Today ${todayFormatted}: Arrival 2 pm — ${name}${descHtml}</li>`);
      }
      // Departure today
      if (event.endYMD === todayYMD) {
        showBookings.push(`<li class="today">Today ${todayFormatted}: Departure 10 am — ${name}${descHtml}</li>`);
      }
      // Arrival tomorrow
      if (event.startYMD === tomorrowYMD) {
        showBookings.push(`<li class="tomorrow">Tomorrow ${tomorrowFormatted}: Arrival 2 pm — ${name}${descHtml}</li>`);
      }
      // Departure tomorrow
      if (event.endYMD === tomorrowYMD) {
        showBookings.push(`<li class="tomorrow">Tomorrow ${tomorrowFormatted}: Departure 10 am — ${name}${descHtml}</li>`);
      }
    });

    if (showBookings.length === 0) {
      list.innerHTML = "<li>No arrivals or departures</li>";
    } else {
      list.innerHTML = showBookings.join("");
    }
    return "✔ OK";
  } catch (err) {
    list.innerHTML = "<li>Feed unavailable</li>";
    return `✖ ${err.message}`;
  }
}

async function refreshAll() {
  const statuses = [];
  for (const [id, url] of Object.entries(villas)) {
    const st = await loadVilla(id, url);
    statuses.push(`${id}: ${st}`);
  }
  const now = new Date().toLocaleTimeString("en-NZ");
  document.getElementById("debug").innerHTML =
    `<strong>Last refresh:</strong> ${now}<br>` + statuses.join("<br>");
}

document.getElementById("current-date").textContent =
  new Date().toLocaleString("en-NZ", {timeZone: "Pacific/Auckland", weekday: "long", day: "numeric", month: "long", year: "numeric"});

refreshAll();
setInterval(refreshAll, 10 * 60 * 1000);
</script>
</body>
</html>
