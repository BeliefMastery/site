<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Patons Rock Villas – Live Bookings</title>
<style>
  body {
    background:#000; color:#fff; font-family:"Segoe UI",Arial,sans-serif;
    margin:0; text-align:center;
  }
  .welcome-banner {
    background:linear-gradient(135deg,#004466,#0077b6);
    padding:20px; border-radius:10px; margin:20px auto;
    max-width:800px; box-shadow:0 4px 12px rgba(0,0,0,0.5);
  }
  .welcome-banner h1 {margin:0 0 8px;font-size:1.8em;text-shadow:0 0 10px #FFD700;}
  #current-date {color:#FFD700;font-size:1.1em;}
  .calendar-grid {
    display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    gap:25px; max-width:1100px; margin:30px auto;
  }
  .calendar-container {
    background:#222; border-radius:15px; padding:15px;
    box-shadow:0 6px 14px rgba(0,0,0,0.6);
  }
  .calendar-container h2 {color:#00b4d8;margin-top:0;}
  .arrivals { color: #4CAF50; }
  .departures { color: #FF5722; }
  ul {list-style:none;padding:0;margin:0;}
  li {padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.1);}
  .debug {
    background:#111; border-top:1px solid #333; margin-top:30px;
    padding:10px; font-size:0.9em; color:#aaa;
  }
  .ok {color:#3fa43f;}
  .fail {color:#ff4444;}
</style>
</head>
<body>
  <div class="welcome-banner">
    <h1>Welcome to Patons Rock Beach Villas</h1>
    <p>For assistance please call <strong>027 356 3551</strong>.</p>
    <div id="current-date"></div>
  </div>

  <h2 id="period-header">Arrivals & Departures</h2>
  <div class="calendar-grid" id="villaGrid">
    <div class="calendar-container"><h2>Villa 1</h2><ul id="villa1"></ul></div>
    <div class="calendar-container"><h2>Villa 2</h2><ul id="villa2"></ul></div>
    <div class="calendar-container"><h2>Villa 3</h2><ul id="villa3"></ul></div>
    <div class="calendar-container"><h2>Villa 4</h2><ul id="villa4"></ul></div>
  </div>

  <div class="debug" id="debug">Loading...</div>

<script>
const villas = {
  villa1: "https://api.beds24.com/ical/bookings.ics?roomid=318483&token=ea7b37ea5fc562875d2a5196a1a77ed8",
  villa2: "https://api.beds24.com/ical/bookings.ics?roomid=318484&token=619894678ee80521412a314854aba411",
  villa3: "https://api.beds24.com/ical/bookings.ics?roomid=318485&token=0dc12d488822f3fb0487273a4d933c84",
  villa4: "https://api.beds24.com/ical/bookings.ics?roomid=318486&token=9634a496cdf402a5c88b5685866a00e8"
};

// Public proxy (CORS bypass)
const proxy = "https://api.allorigins.win/raw?url=";

function getNZDateString(offsetDays = 0) {
  const now = new Date();
  const date = new Date(now.getTime() + offsetDays * 86400000);
  return date.toLocaleDateString("en-CA", {timeZone: "Pacific/Auckland"});
}

function formatDateOnly(dateStr) {
  if (!dateStr) return "—";
  const date = new Date(dateStr + 'T00:00:00');
  return date.toLocaleDateString("en-NZ", {
    timeZone: "Pacific/Auckland",
    day: "numeric", month: "short"
  });
}

function formatTime24to12(time24) {
  if (!time24) return "—";
  const [h, m] = time24.split(':');
  const hour = parseInt(h);
  const ampm = hour >= 12 ? 'pm' : 'am';
  const h12 = hour % 12 || 12;
  return `${h12}:${m} ${ampm}`;
}

function extractName(summary, desc) {
  let name = summary.trim();
  if (name.startsWith("Booking #")) {
    const parts = name.split(" - ");
    name = parts.length > 1 ? parts.pop().trim() : "Guest";
  }
  if (!name || name === "Booking" || name === "") {
    const nameMatch = desc.match(/(?:Name|Guest):\s*([A-Za-z\s]+?)(?=\n|$)/i);
    name = nameMatch ? nameMatch[1].trim() : "Guest";
  }
  return name;
}

function getICSValueInfo(lineType, block) {
  const paramMatch = new RegExp(`${lineType}(;[^:]+)?:(.*)`).exec(block);
  if (!paramMatch) return null;
  const params = paramMatch[1] || '';
  const value = paramMatch[2].trim();
  const hasTZID = params.includes('TZID=Pacific/Auckland');
  const isDateOnly = params.includes('VALUE=DATE');
  const isUTC = value.endsWith('Z');
  let dateStr, timeStr;
  if (isDateOnly) {
    dateStr = value.substring(0,4) + '-' + value.substring(4,2) + '-' + value.substring(6,2);
    timeStr = lineType === 'DTSTART' ? '14:00' : '10:00';
  } else {
    const match = value.match(/(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})(Z)?/);
    if (!match) return null;
    const [,y,m,d,h,mi,s,z] = match;
    if (hasTZID || !isUTC) {
      // local NZ time
      dateStr = `${y}-${m}-${d}`;
      timeStr = `${h}:${mi}`;
    } else {
      // UTC
      const tempISO = `${y}-${m}-${d}T${h}:${mi}:${s}Z`;
      const utcDate = new Date(tempISO);
      dateStr = utcDate.toLocaleDateString("en-CA", {timeZone: "Pacific/Auckland"});
      const localTimeParts = utcDate.toLocaleTimeString("en-NZ", {timeZone: "Pacific/Auckland", hour: '2-digit', minute: '2-digit', hour12: false}).split(':');
      timeStr = `${localTimeParts[0]}:${localTimeParts[1]}`;
    }
  }
  return {dateStr, timeStr};
}

function parseICSEvent(block) {
  const startInfo = getICSValueInfo('DTSTART', block);
  const endInfo = getICSValueInfo('DTEND', block);
  if (!startInfo || !endInfo) return null;
  const summaryMatch = block.match(/SUMMARY:(.+?)(?=\n[A-Z]|$)/);
  const descriptionMatch = block.match(/DESCRIPTION:(.*?)(?:\n[A-Z]|$)/s);
  const summary = summaryMatch ? summaryMatch[1].trim() : "Booking";
  const description = descriptionMatch ? descriptionMatch[1].replace(/\\n/g, " ").replace(/\\,/g, ",").trim() : "";
  return {summary, description, startInfo, endInfo};
}

async function loadVilla(id, url) {
  const list = document.getElementById(id);
  list.innerHTML = "<li>Loading…</li>";
  try {
    const res = await fetch(proxy + encodeURIComponent(url));
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const ics = await res.text();

    const blocks = ics.split("BEGIN:VEVENT").slice(1);
    if (blocks.length === 0) {
      list.innerHTML = "<li>No upcoming bookings</li>";
      return "✔ No bookings";
    }

    const nzToday = getNZDateString(0);
    const nzTomorrow = getNZDateString(1);

    let hasEvents = false;
    let html = "";

    blocks.forEach(block => {
      const event = parseICSEvent(block);
      if (!event) return;

      const name = extractName(event.summary, event.description);

      // Arrival
      const startDay = event.startInfo.dateStr === nzToday ? "today" : (event.startInfo.dateStr === nzTomorrow ? "tomorrow" : null);
      if (startDay) {
        html += `<li class="arrivals"><strong>Arrival ${startDay}:</strong> ${name} at ${formatTime24to12(event.startInfo.timeStr)}<br><small>${event.description}</small></li>`;
        hasEvents = true;
      }

      // Departure
      const endDay = event.endInfo.dateStr === nzToday ? "today" : (event.endInfo.dateStr === nzTomorrow ? "tomorrow" : null);
      if (endDay) {
        html += `<li class="departures"><strong>Departure ${endDay}:</strong> ${name} at ${formatTime24to12(event.endInfo.timeStr)}<br><small>${event.description}</small></li>`;
        hasEvents = true;
      }
    });

    list.innerHTML = hasEvents ? html : "<li>No arrivals or departures today or tomorrow</li>";
    return "✔ OK";
  } catch (err) {
    list.innerHTML = "<li>Feed unavailable</li>";
    return `✖ ${err.message}`;
  }
}

async function refreshAll() {
  const nzToday = getNZDateString(0);
  const nzTomorrow = getNZDateString(1);
  document.getElementById("period-header").textContent = 
    `Arrivals & Departures for ${formatDateOnly(nzToday)} & ${formatDateOnly(nzTomorrow)}`;

  const statuses = [];
  for (const [id, url] of Object.entries(villas)) {
    const st = await loadVilla(id, url);
    statuses.push(`${id}: ${st}`);
  }
  const now = new Date().toLocaleTimeString("en-NZ");
  document.getElementById("debug").innerHTML =
    `<strong>Last refresh:</strong> ${now}<br>` + statuses.join("<br>");
}

// show local NZ date
document.getElementById("current-date").textContent =
  new Date().toLocaleString("en-NZ", {timeZone:"Pacific/Auckland",weekday:"long",day:"numeric",month:"long",year:"numeric"});

refreshAll();
setInterval(refreshAll, 10*60*1000);
</script>
</body>
</html>
