<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patons Rock Villas – Today's Arrival</title>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/dist/luxon.min.js"></script>
<style>
body {
  background:#000; color:#fff; font-family:"Segoe UI",Arial,sans-serif; margin:0; padding:0; text-align:center;
}
.welcome-banner {
  background:linear-gradient(135deg,#004466,#0077b6);
  padding:20px; border-radius:10px; margin:20px auto;
  max-width:900px; box-shadow:0 4px 12px rgba(0,0,0,0.5);
}
.welcome-banner h1 {
  margin:0 0 8px; font-size:1.8em; text-shadow:0 0 10px #FFD700;
}
#welcome-date { color:#FFD700; font-size:1.1em; margin-top:6px; }
.calendar-grid {
  display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:25px; max-width:1100px; margin:30px auto;
}
.calendar-card {
  background:#222; border-radius:15px; padding:15px;
  box-shadow:0 6px 14px rgba(0,0,0,0.6);
  text-align:left;
}
.calendar-card h2 { color:#00b4d8; margin-top:0; }
ul { list-style:none; padding:0; margin:0; }
li { padding:6px 0; border-bottom:1px solid rgba(255,255,255,0.1); }
.arrival { color:#00bfff; font-weight:bold; }
.debug {
  background:#111; border-top:1px solid #333; margin-top:30px;
  padding:10px; font-size:0.9em; color:#aaa;
}
</style>
</head>
<body>

<div class="welcome-banner">
  <h1>Welcome to Patons Rock Beach Villas</h1>
  <p>For assistance please call <strong>027 356 3551</strong>.</p>
  <div id="welcome-date"></div>
</div>

<h2>Today's Arrivals</h2>
<div class="calendar-grid" id="villaGrid">
  <div class="calendar-card"><h2>Villa 1</h2><ul id="villa1"></ul></div>
  <div class="calendar-card"><h2>Villa 2</h2><ul id="villa2"></ul></div>
  <div class="calendar-card"><h2>Villa 3</h2><ul id="villa3"></ul></div>
  <div class="calendar-card"><h2>Villa 4</h2><ul id="villa4"></ul></div>
</div>

<div class="debug" id="debug">Loading...</div>

<script>
const { DateTime, Settings } = luxon;
Settings.defaultLocale = "en-NZ";

const villas = {
  villa1: "https://api.beds24.com/ical/bookings.ics?roomid=318483&token=ea7b37ea5fc562875d2a5196a1a77ed8",
  villa2: "https://api.beds24.com/ical/bookings.ics?roomid=318484&token=619894678ee80521412a314854aba411",
  villa3: "https://api.beds24.com/ical/bookings.ics?roomid=318485&token=0dc12d488822f3fb0487273a4d933c84",
  villa4: "https://api.beds24.com/ical/bookings.ics?roomid=318486&token=9634a496cdf402a5c88b5685866a00e8"
};

const proxy = "https://api.allorigins.win/raw?url=";
const targetTimeZone = "Pacific/Auckland";

function parseICSEvent(block) {
  const startLine = block.match(/DTSTART(?:;VALUE=DATE)?:(.*)/);
  const summaryLine = block.match(/SUMMARY:(.*)/);
  if(!startLine || !summaryLine) return null;

  const startRaw = startLine[1].trim();
  const summary = summaryLine[1].trim();
  let arrivalDate;

  if(startRaw.includes('T') || startRaw.includes('Z')) {
    arrivalDate = DateTime.fromISO(startRaw,{zone:'utc'}).setZone(targetTimeZone);
  } else {
    const year = parseInt(startRaw.substr(0,4));
    const month = parseInt(startRaw.substr(4,2));
    const day = parseInt(startRaw.substr(6,2));
    arrivalDate = DateTime.fromObject({year,month,day,hour:14,minute:0},{zone:targetTimeZone});
  }

  return {summary, arrivalDate};
}

function isSameDayNZ(dt,today) {
  return dt.hasSame(today,'day');
}

function formatNZDate(dt) {
  return dt.toFormat("ccc, dd MMM yyyy");
}

async function loadVilla(id,url){
  const list=document.getElementById(id);
  list.innerHTML="<li>Loading…</li>";
  try{
    const res = await fetch(proxy + encodeURIComponent(url));
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const ics = await res.text();
    const blocks = ics.split("BEGIN:VEVENT").slice(1);
    const todayNZ = DateTime.now().setZone(targetTimeZone).startOf('day');
    let arrival=null;

    for(const block of blocks){
      const event=parseICSEvent(block);
      if(!event) continue;
      if(isSameDayNZ(event.arrivalDate,todayNZ)){
        arrival=`<span class="arrival">${formatNZDate(event.arrivalDate)} — ${event.summary} — check-in 2 pm</span>`;
        break;
      }
    }

    list.innerHTML = arrival ? `<li>${arrival}</li>` : "<li>No arrivals today</li>";
    return "✔ OK";
  }catch(err){
    list.innerHTML="<li>Feed unavailable</li>";
    return `✖ ${err.message}`;
  }
}

async function refreshAll(){
  const statuses=[];
  for(const [id,url] of Object.entries(villas)){
    const st = await loadVilla(id,url);
    statuses.push(`${id}: ${st}`);
  }
  const now = DateTime.now().setZone(targetTimeZone).toFormat('HH:mm:ss');
  document.getElementById("debug").innerHTML=`<strong>Last refresh:</strong> ${now}<br>`+statuses.join("<br>");
}

document.getElementById("welcome-date").textContent = DateTime.now().setZone(targetTimeZone).toFormat('cccc, dd LLLL yyyy');

refreshAll();
setInterval(refreshAll,10*60*1000);
</script>
</body>
</html>
