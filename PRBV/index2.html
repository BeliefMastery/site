<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Patons Rock Villas – Live Bookings</title>
<style>
  body {
    background:#000; color:#fff; font-family:"Segoe UI",Arial,sans-serif;
    margin:0; text-align:center;
  }
  .welcome-banner {
    background:linear-gradient(135deg,#004466,#0077b6);
    padding:20px; border-radius:10px; margin:20px auto;
    max-width:800px; box-shadow:0 4px 12px rgba(0,0,0,0.5);
  }
  .welcome-banner h1 {margin:0 0 8px;font-size:1.8em;text-shadow:0 0 10px #FFD700;}
  #current-date {color:#FFD700;font-size:1.1em;}
  .calendar-grid {
    display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    gap:25px; max-width:1100px; margin:30px auto;
  }
  .calendar-container {
    background:#222; border-radius:15px; padding:15px;
    box-shadow:0 6px 14px rgba(0,0,0,0.6);
  }
  .calendar-container h2 {color:#00b4d8;margin-top:0;}
  ul {list-style:none;padding:0;margin:0;}
  li {padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.1);}
  .debug {
    background:#111; border-top:1px solid #333; margin-top:30px;
    padding:10px; font-size:0.9em; color:#aaa;
  }
  .ok {color:#3fa43f;}
  .fail {color:#ff4444;}
</style>
</head>
<body>
  <div class="welcome-banner">
    <h1>Welcome to Patons Rock Beach Villas</h1>
    <p>For assistance please call <strong>027 356 3551</strong>.</p>
    <div id="current-date"></div>
  </div>

  <h2>Upcoming Bookings</h2>
  <div class="calendar-grid" id="villaGrid">
    <div class="calendar-container"><h2>Villa 1</h2><ul id="villa1"></ul></div>
    <div class="calendar-container"><h2>Villa 2</h2><ul id="villa2"></ul></div>
    <div class="calendar-container"><h2>Villa 3</h2><ul id="villa3"></ul></div>
    <div class="calendar-container"><h2>Villa 4</h2><ul id="villa4"></ul></div>
  </div>

  <div class="debug" id="debug">Loading...</div>

<script>
const villas = {
  villa1: "https://api.beds24.com/ical/bookings.ics?roomid=318483",
  villa2: "https://api.beds24.com/ical/bookings.ics?roomid=318484",
  villa3: "https://api.beds24.com/ical/bookings.ics?roomid=318485",
  villa4: "https://api.beds24.com/ical/bookings.ics?roomid=318486"
};

// Public proxy (CORS bypass)
const proxy = "https://api.allorigins.win/raw?url=";

function cleanICSDate(dt) {
  // Convert e.g. 20251017T140000Z -> 2025-10-17T14:00:00Z
  if (!dt) return null;
  const match = dt.match(/(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})Z?/);
  if (!match) return null;
  const [,y,m,d,h,min,s] = match;
  return `${y}-${m}-${d}T${h}:${min}:${s}Z`;
}

function formatNZDate(iso) {
  if (!iso) return "—";
  const date = new Date(iso);
  return date.toLocaleDateString("en-NZ", {
    timeZone:"Pacific/Auckland",
    day:"numeric", month:"short"
  });
}

async function loadVilla(id, url) {
  const list = document.getElementById(id);
  list.innerHTML = "<li>Loading…</li>";
  try {
    const res = await fetch(proxy + encodeURIComponent(url));
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const ics = await res.text();

    const blocks = ics.split("BEGIN:VEVENT").slice(1);
    if (blocks.length === 0) {
      list.innerHTML = "<li>No upcoming bookings</li>";
      return "✔ No bookings";
    }

    list.innerHTML = "";
    blocks.slice(0,6).forEach(block=>{
      const summary = (block.match(/SUMMARY:(.*)/) || [,"Booking"])[1];
      const startRaw = (block.match(/DTSTART.*:(.*)/) || [,""])[1];
      const endRaw = (block.match(/DTEND.*:(.*)/) || [,""])[1];
      const desc = (block.match(/DESCRIPTION:(.*?)(?:\n[A-Z]|$)/s) || [,""])[1]
                      .replace(/\\n/g," ").trim();

      const start = cleanICSDate(startRaw);
      const end = cleanICSDate(endRaw);
      list.innerHTML += `<li>${formatNZDate(start)} → ${formatNZDate(end)}<br><small>${summary}<br>${desc}</small></li>`;
    });
    return "✔ OK";
  } catch (err) {
    list.innerHTML = "<li>Feed unavailable</li>";
    return `✖ ${err.message}`;
  }
}

async function refreshAll() {
  const statuses = [];
  for (const [id, url] of Object.entries(villas)) {
    const st = await loadVilla(id, url);
    statuses.push(`${id}: ${st}`);
  }
  const now = new Date().toLocaleTimeString("en-NZ");
  document.getElementById("debug").innerHTML =
    `<strong>Last refresh:</strong> ${now}<br>` + statuses.join("<br>");
}

// show local NZ date
document.getElementById("current-date").textContent =
  new Date().toLocaleString("en-NZ", {timeZone:"Pacific/Auckland",weekday:"long",day:"numeric",month:"long",year:"numeric"});

refreshAll();
setInterval(refreshAll, 10*60*1000);
</script>
</body>
</html>
