<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patons Rock Beach Villas – Arrivals Dashboard (NZT)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
:root {
  --primary: #1d4ed8;
  --text-dark: #1f2937;
  --bg-light: #f9fafb;
  --card-bg: #ffffff;
  --success: #10b981;
  --warn: #ef4444;
  --accent1: #3b82f6;
  --accent2: #059669;
  --accent3: #a855f7;
  --accent4: #f59e0b;
}
body {
  font-family: 'Inter', sans-serif;
  background: var(--bg-light);
  color: var(--text-dark);
  min-height: 100vh;
}
.card {
  background: var(--card-bg);
  border-radius: 1rem;
  box-shadow: 0 6px 12px rgba(0,0,0,0.08);
  transition: transform .2s ease;
}
.card:hover {
  transform: translateY(-3px);
}
.villa-title {
  font-weight: 900;
  font-size: 2rem;
  line-height: 1.2;
  margin-bottom: 0.75rem;
}
.villa-sub {
  font-size: 1rem;
  font-weight: 600;
  opacity: .7;
  margin-bottom: 1rem;
}
.loading-icon { animation: spin 1.4s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.no-arrival { color: var(--warn); font-weight: 500; font-style: italic; }
.status-ok { color: var(--success); font-weight: 600; }
.status-warn { color: var(--warn); font-weight: 600; }
</style>
</head>

<body class="p-6 md:p-10">
<div class="max-w-7xl mx-auto">
  <header class="mb-8 text-center bg-white p-6 rounded-xl shadow">
    <h1 class="text-3xl font-extrabold text-gray-900">Welcome to Patons Rock Beach Villas</h1>
    <p class="text-lg text-gray-700 mt-1">We’re delighted to host you. Enjoy your stay, and if you need assistance please call <strong>027 356 3551</strong>.</p>
    <p id="current-date" class="text-xl font-medium text-blue-700 mt-3"></p>
  </header>

  <!-- Villa Grid -->
  <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="card p-6 border-t-4 border-[var(--accent1)]">
      <h2 class="villa-title text-[var(--accent1)]">The Beach House</h2>
      <p class="villa-sub">Villa 1</p>
      <ul id="villa1" class="space-y-4 text-gray-600"><li><i class="fas fa-spinner loading-icon"></i> Loading...</li></ul>
    </div>
    <div class="card p-6 border-t-4 border-[var(--accent2)]">
      <h2 class="villa-title text-[var(--accent2)]">The Cottage</h2>
      <p class="villa-sub">Villa 2</p>
      <ul id="villa2" class="space-y-4 text-gray-600"><li><i class="fas fa-spinner loading-icon"></i> Loading...</li></ul>
    </div>
    <div class="card p-6 border-t-4 border-[var(--accent3)]">
      <h2 class="villa-title text-[var(--accent3)]">The Loft</h2>
      <p class="villa-sub">Villa 3</p>
      <ul id="villa3" class="space-y-4 text-gray-600"><li><i class="fas fa-spinner loading-icon"></i> Loading...</li></ul>
    </div>
    <div class="card p-6 border-t-4 border-[var(--accent4)]">
      <h2 class="villa-title text-[var(--accent4)]">The Retreat</h2>
      <p class="villa-sub">Villa 4</p>
      <ul id="villa4" class="space-y-4 text-gray-600"><li><i class="fas fa-spinner loading-icon"></i> Loading...</li></ul>
    </div>
  </main>

  <footer class="mt-4 p-3 bg-white rounded-xl shadow text-sm text-gray-600">
    <p id="debug">Loading status...</p>
  </footer>
</div>

<script>
const { DateTime, Settings } = luxon;
Settings.defaultLocale = "en-NZ";
const tz = "Pacific/Auckland";
const proxy = "https://api.allorigins.win/raw?url=";

const villaFeeds = {
  villa1:{beds24:"https://api.beds24.com/ical/bookings.ics?roomid=318483&token=ea7b37ea5fc562875d2a5196a1a77ed8"},
  villa2:{beds24:"https://api.beds24.com/ical/bookings.ics?roomid=318484&token=619894678ee80521412a314854aba411"},
  villa3:{beds24:"https://api.beds24.com/ical/bookings.ics?roomid=318485&token=0dc12d488822f3fb0487273a4d933c84"},
  villa4:{beds24:"https://api.beds24.com/ical/bookings.ics?roomid=318486&token=9634a496cdf402a5c88b5685866a00e8"}
};

function parseICSEvent(block){
  const s = block.match(/DTSTART(?:;VALUE=DATE)?:(.*)/);
  const e = block.match(/DTEND(?:;VALUE=DATE)?:(.*)/);
  const sum = block.match(/SUMMARY:(.*)/);
  if(!s||!e||!sum) return null;
  const startRaw=s[1].trim(), endRaw=e[1].trim(), summary=sum[1].trim();
  const fmt = val=>{
    if(val.includes('T')||val.includes('Z'))
      return DateTime.fromISO(val,{zone:'utc'}).setZone(tz);
    return DateTime.fromFormat(val,'yyyyLLdd',{zone:tz, setZone:true}).set({hour:14});
  };
  return {summary,start:fmt(startRaw),end:fmt(endRaw)};
}

async function tryFeed(url){
  const res=await fetch(url);
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const text=await res.text();
  const blocks=text.split("BEGIN:VEVENT").slice(1);
  const today=DateTime.now().setZone(tz).startOf('day');
  for(const b of blocks){
    const ev=parseICSEvent(b);
    if(!ev) continue;
    if(ev.start.hasSame(today,'day'))
      return {state:"arrival",guest:ev.summary,date:ev.start};
    if(ev.start<today && ev.end>today)
      return {state:"occupied",guest:ev.summary,date:ev.start};
  }
  return {state:"none"};
}

async function loadVilla(id,feeds){
  const el=document.getElementById(id);
  el.innerHTML="<li><i class='fas fa-spinner loading-icon'></i> Loading…</li>";
  try {
    const data=await tryFeed(proxy+encodeURIComponent(feeds.beds24));
    if(data.state==="arrival"){
      el.innerHTML=`<li>
        <span class='font-bold text-xl text-emerald-600'>${data.guest}</span><br>
        <span class='text-gray-600'>Arrival: ${data.date.toFormat("ccc dd MMM yyyy")}</span><br>
        <span class='text-blue-700'><i class='fas fa-clock'></i> Check-in 2 PM</span>
      </li>`;
      return `✔ Arrival Today (${data.guest})`;
    }
    if(data.state==="occupied"){
      el.innerHTML=`<li class='text-gray-700'><i class='fas fa-bed'></i> Room Occupied – ongoing stay (${data.guest})</li>`;
      return `ℹ Occupied – ongoing stay`;
    }
    if(data.state==="none"){
      el.innerHTML=`<li class='no-arrival'><i class='fas fa-calendar-times'></i> No bookings today</li>`;
      return `– No booking today`;
    }
  } catch(e){
    console.warn(`${id} feed error`,e);
    el.innerHTML=`<li class='no-arrival'><i class='fas fa-exclamation-triangle'></i> Data error</li>`;
    return `⚠ Feed error`;
  }
}

async function refreshAll(){
  const status=[];
  for(const [id,feeds] of Object.entries(villaFeeds)){
    const st=await loadVilla(id,feeds);
    status.push(`${id}: ${st}`);
  }
  const now=DateTime.now().setZone(tz).toFormat("HH:mm:ss");
  document.getElementById("debug").innerHTML=`<strong>Last refresh:</strong> ${now} NZT | ${status.join(' | ')}`;
}

window.onload=()=>{
  document.getElementById("current-date").textContent=
    DateTime.now().setZone(tz).toFormat("cccc, dd LLLL yyyy");
  refreshAll();
  setInterval(refreshAll,10*60*1000);
};
</script>
</body>
</html>
