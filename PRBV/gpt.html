<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Patons Rock Beach Villas — Daily Arrivals</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Luxon -->
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
body {
  font-family: 'Inter', sans-serif;
  background: linear-gradient(180deg, #f0f8ff 0%, #fff 60%);
  color: #1f2937;
  min-height: 100vh;
}

/* --- Header + Welcome --- */
.hero {
  background: linear-gradient(90deg, #60a5fa 0%, #3b82f6 50%, #2563eb 100%);
  color: white;
  border-radius: 1rem;
  padding: 2rem 1.5rem;
  box-shadow: 0 8px 25px rgba(37, 99, 235, 0.2);
  animation: fadeIn 1.2s ease-in;
}
.hero h1 {
  font-size: 2.25rem;
  font-weight: 800;
  letter-spacing: -0.02em;
}
.hero p {
  margin-top: 0.5rem;
  font-size: 1.15rem;
  font-weight: 500;
}

/* --- Card Design --- */
.card {
  background: #ffffff;
  border-radius: 1rem;
  padding: 1.5rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.06);
  transition: all 0.3s ease;
}
.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 20px rgba(0,0,0,0.08);
}
.villa-title {
  border-bottom: 3px solid #2563eb;
  padding-bottom: 0.5rem;
  font-weight: 700;
  color: #1e40af;
  margin-bottom: 1rem;
}

/* --- Arrival Info --- */
.arrival-info {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}
.guest-name {
  color: #10b981;
  font-size: 1.25rem;
  font-weight: 700;
}
.date {
  color: #4b5563;
  font-size: 1rem;
}
.check-in {
  color: #2563eb;
  font-size: 0.9rem;
  font-weight: 500;
}
.no-arrival {
  color: #ef4444;
  font-weight: 600;
  font-style: italic;
}

/* --- Footer/Status Bar --- */
.debug-bar {
  background: white;
  border-radius: 0.75rem;
  padding: 0.75rem 1rem;
  font-size: 0.85rem;
  color: #6b7280;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

/* --- Animations --- */
.loading-icon {
  animation: spin 1.5s linear infinite;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* --- Responsive --- */
@media (max-width: 640px) {
  .hero h1 { font-size: 1.75rem; }
}
</style>
</head>

<body class="p-4 md:p-8">
<div class="max-w-7xl mx-auto space-y-8">

  <!-- Welcome Header -->
  <section class="hero text-center">
    <h1>Welcome to Patons Rock Beach Villas</h1>
    <p>We’re delighted to host you. Enjoy your stay, and if you need assistance please call <strong>027 356 3551</strong>.</p>
    <p id="current-date" class="mt-2 text-blue-100 font-semibold"></p>
  </section>

  <!-- Villa Cards -->
  <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
    <div class="card"><h2 class="villa-title">Villa 1 · The Beach House</h2><ul id="villa1"><li><i class="fas fa-spinner loading-icon"></i> Initializing…</li></ul></div>
    <div class="card"><h2 class="villa-title">Villa 2 · The Cottage</h2><ul id="villa2"><li><i class="fas fa-spinner loading-icon"></i> Initializing…</li></ul></div>
    <div class="card"><h2 class="villa-title">Villa 3 · The Loft</h2><ul id="villa3"><li><i class="fas fa-spinner loading-icon"></i> Initializing…</li></ul></div>
    <div class="card"><h2 class="villa-title">Villa 4 · The Retreat</h2><ul id="villa4"><li><i class="fas fa-spinner loading-icon"></i> Initializing…</li></ul></div>
  </main>

  <!-- Footer -->
  <footer class="debug-bar text-center"><p id="debug">Loading status…</p></footer>
</div>

<!-- JavaScript (identical logic to your working version) -->
<script>
const { DateTime, Settings } = luxon;
Settings.defaultLocale = "en-NZ";
const targetTimeZone = "Pacific/Auckland";
const proxy = "https://api.allorigins.win/raw?url=";

const villaFeeds = {
  villa1: { beds24: "https://api.beds24.com/ical/bookings.ics?roomid=318483&token=ea7b37ea5fc562875d2a5196a1a77ed8",
            google: "https://calendar.google.com/calendar/ical/patonsrockbeachvillas.co.nz_5r3b0ovo5vn9l24j5503docbds%40group.calendar.google.com/public/basic.ics" },
  villa2: { beds24: "https://api.beds24.com/ical/bookings.ics?roomid=318484&token=619894678ee80521412a314854aba411",
            google: "https://calendar.google.com/calendar/ical/u8thu0g7p9eot6ppob2etrr4kun3h47n%40import.calendar.google.com/public/basic.ics" },
  villa3: { beds24: "https://api.beds24.com/ical/bookings.ics?roomid=318485&token=0dc12d488822f3fb0487273a4d933c84",
            google: "https://calendar.google.com/calendar/ical/ksclvfhel50fao7ebrmkoan888uhvpo8%40import.calendar.google.com/public/basic.ics" },
  villa4: { beds24: "https://api.beds24.com/ical/bookings.ics?roomid=318486&token=9634a496cdf402a5c88b5685866a00e8",
            google: "https://calendar.google.com/calendar/ical/sjrqdsa4n3ril7criqoh5k4ofhehep33%40import.calendar.google.com/public/basic.ics" }
};

function parseICSEvent(block){
  const startLine = block.match(/DTSTART(?:;VALUE=DATE)?:(.*)/);
  const summaryLine = block.match(/SUMMARY:(.*)/);
  if (!startLine || !summaryLine) return null;
  const startRaw = startLine[1].trim();
  const summary = summaryLine[1].trim();
  let arrivalDate;
  const isDateTime = startRaw.includes('T') || startRaw.includes('Z');
  if (isDateTime) {
    arrivalDate = DateTime.fromISO(startRaw, { zone: 'utc' }).setZone(targetTimeZone);
  } else {
    const year = +startRaw.substr(0,4), month = +startRaw.substr(4,2), day = +startRaw.substr(6,2);
    arrivalDate = DateTime.fromObject({ year, month, day, hour: 14 }, { zone: targetTimeZone });
  }
  return { summary, arrivalDate };
}

function isSameDayNZ(dt, today){ return dt.hasSame(today, 'day'); }
function formatNZDate(dt){ return dt.toFormat("ccc, dd MMM yyyy"); }

async function tryFeed(url){
  const res = await fetch(url);
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const ics = await res.text();
  const blocks = ics.split("BEGIN:VEVENT").slice(1);
  const todayNZ = DateTime.now().setZone(targetTimeZone).startOf('day');
  for(const block of blocks){
    const event = parseICSEvent(block);
    if(event && isSameDayNZ(event.arrivalDate, todayNZ)){
      return `<span class="arrival-info">
        <span class="guest-name">${event.summary}</span>
        <span class="date">${formatNZDate(event.arrivalDate)}</span>
        <span class="check-in"><i class="fas fa-clock"></i> Check-in 2 PM</span>
      </span>`;
    }
  }
  return null;
}

async function loadVilla(id, feeds){
  const list = document.getElementById(id);
  list.innerHTML="<li><i class='fas fa-spinner loading-icon'></i> Loading…</li>";
  const attempts = [
    { name:'Beds24 (Proxy)', url: proxy + encodeURIComponent(feeds.beds24) },
    { name:'Google (Direct)', url: feeds.google },
    { name:'Google (Proxy)', url: proxy + encodeURIComponent(feeds.google) }
  ];
  let statusMessage = `<span class='text-red-500 font-semibold'>✖ Failed</span>`;
  for(const attempt of attempts){
    try{
      const arrival = await tryFeed(attempt.url);
      if(arrival){
        list.innerHTML = `<li>${arrival}</li>`;
        statusMessage = `<span class='text-green-600 font-semibold'>✔ OK (${attempt.name})</span>`;
        return statusMessage;
      }
    }catch(e){ console.warn(`${id} - ${attempt.name} failed:`, e.message); }
  }
  list.innerHTML="<li class='no-arrival'><i class='fas fa-calendar-times'></i> Room Occupied or No arrivals today</li>";
  return statusMessage;
}

async function refreshAll(){
  const statuses=[];
  for(const [id,feeds] of Object.entries(villaFeeds)){
    const st = await loadVilla(id,feeds);
    statuses.push(`${id}: ${st}`);
  }
  const now = DateTime.now().setZone(targetTimeZone).toFormat('HH:mm:ss');
  document.getElementById("debug").innerHTML = `<strong>Last refresh:</strong> ${now} NZT | ${statuses.join(' | ')}`;
}

window.onload = function(){
  document.getElementById("current-date").textContent =
    DateTime.now().setZone(targetTimeZone).toFormat('cccc, dd LLLL yyyy');
  refreshAll();
  setInterval(refreshAll, 10*60*1000);
};
</script>
</body>
</html>
