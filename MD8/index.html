<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Mediation Platform</title>
    <meta name="description" content="Professional Case Management & Mediation Platform with AI Integration">
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a365d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Mediation Platform">
    
    <style>
        /* Enhanced CSS Variables */
        :root {
            --primary-color: #1a365d;
            --primary-light: #2c5282;
            --primary-dark: #0f2027;
            --secondary-color: #2d3748;
            --accent-color: #3182ce;
            --success-color: #38a169;
            --warning-color: #d69e2e;
            --error-color: #e53e3e;
            --info-color: #3182ce;
            
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --text-light: #a0aec0;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f7fafc;
            --bg-tertiary: #edf2f7;
            --bg-card: #ffffff;
            --bg-hover: #f1f5f9;
            
            --border-color: #e2e8f0;
            --border-light: #f1f5f9;
            --border-dark: #cbd5e0;
            
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Authentication Styles */
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .auth-card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            padding: 3rem;
            width: 100%;
            max-width: 500px;
            border: 1px solid var(--border-color);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .auth-logo {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .auth-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .auth-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .auth-tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1rem;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .auth-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }

        .auth-tab:hover {
            color: var(--primary-color);
            background: var(--bg-hover);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 1rem;
            transition: all 0.2s;
            background: var(--bg-primary);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1);
        }

        .btn {
            width: 100%;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-light);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--text-secondary);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-danger {
            background: var(--error-color);
            color: white;
        }

        /* Main Application Styles */
        .app-container {
            display: none;
        }

        .app-container.active {
            display: block;
        }

        .header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-role {
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 600;
        }

        .role-mediator {
            background: var(--info-color);
            color: white;
        }

        .role-client {
            background: var(--success-color);
            color: white;
        }

        .logout-btn {
            padding: 0.5rem 1rem;
            background: var(--error-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.875rem;
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            transition: transform 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .metric-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .metric-icon {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .metric-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            line-height: 1;
        }

        .metric-description {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        .section {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .action-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            color: inherit;
        }

        .action-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }

        .action-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .action-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .action-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Case Management Styles */
        .cases-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .case-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--primary-color);
            transition: all 0.2s;
        }

        .case-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .case-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .case-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .case-number {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-retired {
            background: #f8d7da;
            color: #721c24;
        }

        .case-meta {
            display: flex;
            justify-content: space-between;
            margin: 1rem 0;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .case-description {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .case-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border-radius: var(--radius-sm);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            padding: 0.5rem;
            border-radius: var(--radius-sm);
        }

        .modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        /* Client Information Collection */
        .info-collection {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin: 1rem 0;
            border: 1px solid var(--border-color);
        }

        .info-section {
            margin-bottom: 2rem;
        }

        .info-section:last-child {
            margin-bottom: 0;
        }

        .info-section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
        }

        /* Mediator Selection Styles */
        .mediator-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .mediator-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .mediator-option:hover {
            border-color: var(--primary-color);
            background: var(--bg-hover);
        }

        .mediator-option input[type="checkbox"] {
            margin: 0;
        }

        .mediator-info {
            flex: 1;
        }

        .mediator-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .mediator-specialties {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Case Type Specific Forms */
        .case-type-fields {
            margin-top: 1rem;
            padding: 1.5rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .case-type-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Visibility Controls */
        .visibility-controls {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-top: 1rem;
            border: 1px solid var(--border-color);
        }

        .visibility-section {
            margin-bottom: 1rem;
        }

        .visibility-section:last-child {
            margin-bottom: 0;
        }

        .visibility-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .visibility-options {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .visibility-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .visibility-option input[type="checkbox"] {
            margin: 0;
        }

        .visibility-option label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        /* Archive and Export Styles */
        .case-actions-extended {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .btn-export {
            background: var(--info-color);
            color: white;
        }

        .btn-export:hover {
            background: #2c5282;
        }

        .btn-archive {
            background: var(--warning-color);
            color: white;
        }

        .btn-archive:hover {
            background: #b7791f;
        }

        .btn-delete {
            background: var(--error-color);
            color: white;
        }

        .btn-delete:hover {
            background: #c53030;
        }

        /* Archive Modal Styles */
        .archive-options {
            display: grid;
            gap: 1rem;
        }

        .archive-option {
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
        }

        .archive-option:hover {
            border-color: var(--warning-color);
            background: var(--bg-hover);
        }

        .archive-option input[type="radio"] {
            margin-right: 0.5rem;
        }

        .archive-option-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .archive-option-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .auth-card {
                padding: 2rem 1.5rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .main-content {
            padding: 1rem;
            }

            .dashboard {
                grid-template-columns: 1fr;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }

            .cases-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .form-actions {
                flex-direction: column;
            }

            .modal-content {
                margin: 1rem;
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Section -->
    <div id="auth-section" class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <div class="auth-logo">⚖️</div>
                <h1 class="auth-title">Unified Mediation Platform</h1>
                <p class="auth-subtitle">Professional Case Management & Mediation</p>
                
                <!-- Debug button (remove in production) -->
                <div style="margin-top: 1rem; text-align: center;">
                    <button type="button" onclick="testDashboard()" style="background: #6c757d; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.8rem;">
                        🔧 Test Dashboard (Debug)
                    </button>
                </div>
            </div>

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login')">Login</button>
                <button class="auth-tab" onclick="showAuthTab('register')">Register</button>
            </div>

            <!-- Login Form -->
            <form id="login-form" class="auth-form active">
                <div class="form-group">
                    <label for="login-email">Email Address</label>
                    <input type="email" id="login-email" required placeholder="your.email@example.com">
            </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" required>
            </div>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>

            <!-- Registration Form -->
            <form id="register-form" class="auth-form">
                <div class="form-group">
                    <label for="reg-name">Full Name</label>
                    <input type="text" id="reg-name" required>
            </div>
                <div class="form-group">
                    <label for="reg-email">Email Address</label>
                    <input type="email" id="reg-email" required>
                </div>
                <div class="form-group">
                    <label for="reg-organization">Organization (Optional)</label>
                    <input type="text" id="reg-organization">
                </div>
                <div class="form-group">
                    <label for="reg-phone">Phone Number (Optional)</label>
                    <input type="tel" id="reg-phone">
                </div>
                <div class="form-group">
                    <label for="reg-role">Account Type</label>
                    <select id="reg-role" required onchange="toggleMediatorSelection()">
                        <option value="">Select Role</option>
                        <option value="mediator">Mediator - Create and manage cases</option>
                        <option value="client">Client - Access assigned cases</option>
                    </select>
                </div>
                <div id="mediator-selection" class="form-group hidden">
                    <label for="preferred-mediators">Select Preferred Mediators (Optional)</label>
                    <div id="mediator-checkboxes" class="mediator-selection">
                        <!-- Mediators will be loaded here -->
                    </div>
                    <small style="color: var(--text-muted);">You can change your mediator preferences later. Mediators will be able to assign you to cases based on your selections.</small>
                </div>
                <div class="form-group">
                    <label for="reg-password">Password</label>
                    <input type="password" id="reg-password" required>
                </div>
                <div class="form-group">
                    <label for="reg-confirm">Confirm Password</label>
                    <input type="password" id="reg-confirm" required>
                </div>
                <button type="submit" class="btn btn-primary">Register</button>
            </form>
            </div>
        </div>
        
    <!-- Main Application -->
    <div id="app-section" class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <span>⚖️</span>
                    <span>Unified Mediation Platform</span>
                </div>
                <div class="user-info">
                    <span id="user-name">Loading...</span>
                    <span id="user-role" class="user-role">Loading...</span>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Mediator Dashboard -->
            <div id="mediator-dashboard" class="hidden">
                <div class="dashboard">
                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-icon">📋</span>
                            <span class="metric-title">Active Cases</span>
                        </div>
                        <div class="metric-value" id="active-cases-count">0</div>
                        <div class="metric-description">Cases currently in progress</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-icon">🤝</span>
                            <span class="metric-title">Sessions Today</span>
                        </div>
                        <div class="metric-value" id="sessions-today-count">0</div>
                        <div class="metric-description">Mediation sessions scheduled</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-icon">👥</span>
                            <span class="metric-title">Assigned Clients</span>
                        </div>
                        <div class="metric-value" id="assigned-clients-count">0</div>
                        <div class="metric-description">Clients assigned to your cases</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-icon">✅</span>
                            <span class="metric-title">Resolved Cases</span>
                        </div>
                        <div class="metric-value" id="resolved-cases-count">0</div>
                        <div class="metric-description">Successfully resolved this month</div>
                    </div>
                </div>
        
                <div class="quick-actions">
                    <a href="#" class="action-card" onclick="openModal('new-case-modal')">
                        <div class="action-icon">📋</div>
                        <div class="action-title">Create New Case</div>
                        <div class="action-description">Start a new mediation case and assign clients</div>
                    </a>
                    <a href="#" class="action-card" onclick="openModal('assign-client-modal')">
                        <div class="action-icon">👥</div>
                        <div class="action-title">Assign Client to Case</div>
                        <div class="action-description">Add clients to existing cases</div>
                    </a>
                    <a href="#" class="action-card" onclick="openModal('new-session-modal')">
                        <div class="action-icon">🤝</div>
                        <div class="action-title">Schedule Session</div>
                        <div class="action-description">Book a mediation session</div>
                    </a>
                    <a href="#" class="action-card" onclick="showUserManagement()">
                        <div class="action-icon">👤</div>
                        <div class="action-title">User Management</div>
                        <div class="action-description">Manage mediators and clients</div>
                    </a>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">📋 Your Cases</h2>
                        <button class="btn btn-primary btn-sm" onclick="openModal('new-case-modal')">Create Case</button>
                    </div>
                    <div class="cases-grid" id="mediator-cases">
                        <!-- Cases will be loaded here -->
                    </div>
                </div>
        </div>
        
            <!-- Client Dashboard -->
            <div id="client-dashboard" class="hidden">
                <div class="dashboard">
                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-icon">📋</span>
                            <span class="metric-title">My Cases</span>
                        </div>
                        <div class="metric-value" id="client-cases-count">0</div>
                        <div class="metric-description">Cases you're involved in</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-icon">🤝</span>
                            <span class="metric-title">Upcoming Sessions</span>
                        </div>
                        <div class="metric-value" id="upcoming-sessions-count">0</div>
                        <div class="metric-description">Sessions scheduled this week</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-icon">📝</span>
                            <span class="metric-title">Forms Pending</span>
                        </div>
                        <div class="metric-value" id="pending-forms-count">0</div>
                        <div class="metric-description">Information forms to complete</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-icon">📊</span>
                            <span class="metric-title">Progress</span>
                        </div>
                        <div class="metric-value">0%</div>
                        <div class="metric-description">Overall case progress</div>
        </div>
    </div>

                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">📋 My Cases</h2>
                    </div>
                    <div class="cases-grid" id="client-cases">
                        <!-- Client cases will be loaded here -->
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">📝 Information Collection</h2>
                    </div>
                    <div id="client-forms">
                        <!-- Client forms will be loaded here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- New Case Modal -->
    <div id="new-case-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">📋 Create New Case</h3>
                <button class="modal-close" onclick="closeModal('new-case-modal')">&times;</button>
            </div>
            <form id="new-case-form">
                <div class="form-group">
                    <label for="case-title">Case Title</label>
                    <input type="text" id="case-title" required placeholder="e.g., Property Boundary Dispute">
                </div>
                <div class="form-group">
                    <label for="case-description">Case Description</label>
                    <textarea id="case-description" rows="4" required placeholder="Describe the nature of the dispute..."></textarea>
                </div>
                <div class="form-row">
                <div class="form-group">
                    <label for="case-category">Category</label>
                    <select id="case-category" required onchange="loadCaseTypeFields()">
                        <option value="">Select Category</option>
                        <option value="property">Property Dispute</option>
                        <option value="business">Business Conflict</option>
                        <option value="family">Family Mediation</option>
                        <option value="employment">Employment Dispute</option>
                        <option value="community">Community Dispute</option>
                        <option value="commercial">Commercial Dispute</option>
                    </select>
                </div>
                <div id="case-type-fields-container" class="case-type-fields hidden">
                    <div class="case-type-title">
                        <span id="case-type-icon">📋</span>
                        <span id="case-type-name">Case Type Specific Information</span>
                    </div>
                    <div id="case-type-fields">
                        <!-- Dynamic fields will be loaded here -->
                    </div>
                </div>
                    <div class="form-group">
                        <label for="case-priority">Priority</label>
                        <select id="case-priority" required>
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="case-mediator">Assigned Mediator</label>
                    <select id="case-mediator" required>
                        <option value="">Select Mediator</option>
                        <option value="current" selected>Current User</option>
                        <option value="other">Other Mediator</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('new-case-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Case</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Assign Client Modal -->
    <div id="assign-client-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">👥 Assign Client to Case</h3>
                <button class="modal-close" onclick="closeModal('assign-client-modal')">&times;</button>
            </div>
            <form id="assign-client-form">
                <div class="form-group">
                    <label for="assign-case">Select Case</label>
                    <select id="assign-case" required>
                        <option value="">Select Case</option>
                        <option value="001">Case #001 - Property Boundary Dispute</option>
                        <option value="002">Case #002 - Business Partnership Conflict</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="assign-client">Select Client</label>
                    <select id="assign-client" required>
                        <option value="">Select Client</option>
                        <option value="client1">John Smith (john@example.com)</option>
                        <option value="client2">Sarah Johnson (sarah@example.com)</option>
                        <option value="client3">Michael Brown (michael@example.com)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="client-role">Client Role</label>
                    <select id="client-role" required>
                        <option value="party1">Primary Party</option>
                        <option value="party2">Secondary Party</option>
                        <option value="witness">Witness</option>
                        <option value="support">Support Person</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('assign-client-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Assign Client</button>
                </div>
            </form>
        </div>
        </div>
        
    <!-- New Session Modal -->
    <div id="new-session-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🤝 Schedule Mediation Session</h3>
                <button class="modal-close" onclick="closeModal('new-session-modal')">&times;</button>
            </div>
            <form id="new-session-form">
                <div class="form-group">
                    <label for="session-case">Select Case</label>
                    <select id="session-case" required>
                        <option value="">Select Case</option>
                        <option value="001">Case #001 - Property Boundary Dispute</option>
                        <option value="002">Case #002 - Business Partnership Conflict</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="session-date">Date & Time</label>
                        <input type="datetime-local" id="session-date" required>
                    </div>
                    <div class="form-group">
                        <label for="session-duration">Duration (hours)</label>
                        <select id="session-duration" required>
                            <option value="1">1 hour</option>
                            <option value="2" selected>2 hours</option>
                            <option value="3">3 hours</option>
                            <option value="4">4 hours</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="session-location">Location</label>
                    <input type="text" id="session-location" placeholder="Conference Room A, 123 Main St" required>
                </div>
                <div class="form-group">
                    <label for="session-type">Session Type</label>
                    <select id="session-type" required>
                        <option value="joint" selected>Joint Session</option>
                        <option value="individual">Individual Session</option>
                        <option value="caucus">Caucus Session</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('new-session-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Schedule Session</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Archive Case Modal -->
    <div id="archive-case-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">📦 Archive Case</h3>
                <button class="modal-close" onclick="closeModal('archive-case-modal')">&times;</button>
            </div>
            <form id="archive-case-form">
                <div class="form-group">
                    <label>Select Archive Action:</label>
                    <div class="archive-options">
                        <label class="archive-option">
                            <input type="radio" name="archive-action" value="archive" checked>
                            <div class="archive-option-title">Archive Case</div>
                            <div class="archive-option-description">Move case to archive. Can be restored later.</div>
                        </label>
                        <label class="archive-option">
                            <input type="radio" name="archive-action" value="delete">
                            <div class="archive-option-title">Delete Case</div>
                            <div class="archive-option-description">Permanently delete case and all associated data.</div>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="archive-reason">Reason for Archiving/Deletion</label>
                    <textarea id="archive-reason" rows="3" placeholder="Explain why this case is being archived or deleted..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('archive-case-modal')">Cancel</button>
                    <button type="submit" class="btn btn-warning">Archive/Delete Case</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Export Data Modal -->
    <div id="export-data-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">📊 Export Case Data</h3>
                <button class="modal-close" onclick="closeModal('export-data-modal')">&times;</button>
            </div>
            <form id="export-data-form">
                <div class="form-group">
                    <label>Select Data to Export:</label>
                    <div class="archive-options">
                        <label class="archive-option">
                            <input type="checkbox" name="export-data" value="case-details" checked>
                            <div class="archive-option-title">Case Details</div>
                            <div class="archive-option-description">Basic case information and status</div>
                        </label>
                        <label class="archive-option">
                            <input type="checkbox" name="export-data" value="client-info" checked>
                            <div class="archive-option-title">Client Information</div>
                            <div class="archive-option-description">All client details and contact information</div>
                        </label>
                        <label class="archive-option">
                            <input type="checkbox" name="export-data" value="case-logs" checked>
                            <div class="archive-option-title">Case Logs</div>
                            <div class="archive-option-description">Session notes and activity history</div>
                        </label>
                        <label class="archive-option">
                            <input type="checkbox" name="export-data" value="documents">
                            <div class="archive-option-title">Documents</div>
                            <div class="archive-option-description">Uploaded files and attachments</div>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="export-format">Export Format</label>
                    <select id="export-format" required>
                        <option value="csv">CSV (Excel Compatible)</option>
                        <option value="json">JSON (Structured Data)</option>
                        <option value="pdf">PDF Report</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('export-data-modal')">Cancel</button>
                    <button type="submit" class="btn btn-export">Export Data</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Client Case Details Modal -->
    <div id="client-case-details-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">📝 Case Details & Information Collection</h3>
                <button class="modal-close" onclick="closeModal('client-case-details-modal')">&times;</button>
            </div>
            <form id="client-case-details-form">
                <div id="client-case-info">
                    <!-- Case information will be loaded here -->
                </div>
                <div id="client-case-fields">
                    <!-- Case-specific fields will be loaded here -->
                </div>
                <div class="visibility-controls">
                    <div class="visibility-section">
                        <div class="visibility-title">🔒 Information Visibility Settings</div>
                        <div class="visibility-options">
                            <div class="visibility-option">
                                <input type="checkbox" id="visible-to-mediator" checked disabled>
                                <label for="visible-to-mediator">Visible to Mediator (Always)</label>
                            </div>
                            <div class="visibility-option">
                                <input type="checkbox" id="visible-to-other-parties">
                                <label for="visible-to-other-parties">Visible to Other Parties</label>
                            </div>
                            <div class="visibility-option">
                                <input type="checkbox" id="visible-to-support">
                                <label for="visible-to-support">Visible to Support Persons</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('client-case-details-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit Information</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Include Local Storage Backend -->
    <script src="local_storage_backend.js"></script>
    
    <script>
        // Global state
        let currentUser = null;
        let userRole = null;
        let selectedMediators = [];
        const USE_LOCAL_STORAGE = true; // Set to false to use API server
        const API_BASE_URL = 'http://localhost:5000/api';
        let caseTypes = {
            'property': {
                name: 'Property Dispute',
                fields: [
                    { id: 'property_address', label: 'Property Address', type: 'text', required: true },
                    { id: 'dispute_type', label: 'Type of Dispute', type: 'select', options: ['Boundary', 'Easement', 'Access Rights', 'Zoning', 'Other'], required: true },
                    { id: 'property_value', label: 'Estimated Property Value', type: 'number', required: false },
                    { id: 'survey_available', label: 'Survey Available', type: 'select', options: ['Yes', 'No', 'Partial'], required: true },
                    { id: 'legal_documents', label: 'Legal Documents Available', type: 'textarea', required: false },
                    { id: 'timeline_urgency', label: 'Timeline Urgency', type: 'select', options: ['Low', 'Medium', 'High', 'Critical'], required: true }
                ]
            },
            'business': {
                name: 'Business Conflict',
                fields: [
                    { id: 'business_type', label: 'Type of Business', type: 'text', required: true },
                    { id: 'conflict_nature', label: 'Nature of Conflict', type: 'select', options: ['Partnership', 'Contract', 'Intellectual Property', 'Employment', 'Financial', 'Other'], required: true },
                    { id: 'business_value', label: 'Business Value/Range', type: 'text', required: false },
                    { id: 'contracts_available', label: 'Contracts/Agreements Available', type: 'select', options: ['Yes', 'No', 'Partial'], required: true },
                    { id: 'financial_documents', label: 'Financial Documents', type: 'textarea', required: false },
                    { id: 'resolution_timeline', label: 'Preferred Resolution Timeline', type: 'select', options: ['ASAP', '1 month', '3 months', '6 months', 'Flexible'], required: true }
                ]
            },
            'family': {
                name: 'Family Mediation',
                fields: [
                    { id: 'family_relationship', label: 'Family Relationship', type: 'select', options: ['Spouse', 'Parent-Child', 'Siblings', 'Extended Family', 'Other'], required: true },
                    { id: 'mediation_focus', label: 'Mediation Focus', type: 'select', options: ['Divorce', 'Custody', 'Estate', 'Care Arrangements', 'Financial Support', 'Other'], required: true },
                    { id: 'children_involved', label: 'Children Involved', type: 'select', options: ['Yes', 'No'], required: true },
                    { id: 'children_ages', label: 'Children Ages (if applicable)', type: 'text', required: false },
                    { id: 'legal_proceedings', label: 'Ongoing Legal Proceedings', type: 'select', options: ['Yes', 'No', 'Pending'], required: true },
                    { id: 'safety_concerns', label: 'Safety Concerns', type: 'select', options: ['None', 'Low', 'Medium', 'High'], required: true }
                ]
            },
            'employment': {
                name: 'Employment Dispute',
                fields: [
                    { id: 'employment_type', label: 'Employment Type', type: 'select', options: ['Full-time', 'Part-time', 'Contract', 'Consultant', 'Other'], required: true },
                    { id: 'dispute_category', label: 'Dispute Category', type: 'select', options: ['Termination', 'Discrimination', 'Harassment', 'Wages', 'Benefits', 'Workplace Conditions', 'Other'], required: true },
                    { id: 'employment_duration', label: 'Employment Duration', type: 'text', required: false },
                    { id: 'contract_available', label: 'Employment Contract Available', type: 'select', options: ['Yes', 'No'], required: true },
                    { id: 'supporting_documents', label: 'Supporting Documents', type: 'textarea', required: false },
                    { id: 'resolution_preference', label: 'Resolution Preference', type: 'select', options: ['Financial Settlement', 'Reinstatement', 'Reference Letter', 'Policy Change', 'Other'], required: true }
                ]
            },
            'community': {
                name: 'Community Dispute',
                fields: [
                    { id: 'community_type', label: 'Community Type', type: 'select', options: ['Residential', 'Commercial', 'Mixed Use', 'HOA', 'Strata', 'Other'], required: true },
                    { id: 'dispute_scope', label: 'Dispute Scope', type: 'select', options: ['Individual', 'Multiple Residents', 'Community-wide', 'External Party'], required: true },
                    { id: 'issue_type', label: 'Issue Type', type: 'select', options: ['Noise', 'Property Maintenance', 'Shared Spaces', 'Rules/By-laws', 'Financial', 'Other'], required: true },
                    { id: 'duration_issue', label: 'How Long Has This Been an Issue', type: 'select', options: ['Days', 'Weeks', 'Months', 'Years'], required: true },
                    { id: 'previous_attempts', label: 'Previous Resolution Attempts', type: 'textarea', required: false },
                    { id: 'community_impact', label: 'Community Impact Level', type: 'select', options: ['Minimal', 'Moderate', 'Significant', 'Community-wide'], required: true }
                ]
            },
            'commercial': {
                name: 'Commercial Dispute',
                fields: [
                    { id: 'business_relationship', label: 'Business Relationship', type: 'select', options: ['Vendor-Client', 'Partnership', 'Joint Venture', 'Franchise', 'Supply Chain', 'Other'], required: true },
                    { id: 'dispute_value', label: 'Estimated Dispute Value', type: 'select', options: ['Under $10K', '$10K-$50K', '$50K-$100K', '$100K-$500K', 'Over $500K'], required: true },
                    { id: 'contract_basis', label: 'Contract Basis', type: 'select', options: ['Written Contract', 'Verbal Agreement', 'Implied Terms', 'No Contract'], required: true },
                    { id: 'performance_issues', label: 'Performance Issues', type: 'textarea', required: false },
                    { id: 'financial_impact', label: 'Financial Impact', type: 'textarea', required: false },
                    { id: 'resolution_priority', label: 'Resolution Priority', type: 'select', options: ['Financial Recovery', 'Relationship Repair', 'Precedent Setting', 'Time Efficiency', 'Other'], required: true }
                ]
            }
        };

        // Mediator selection functions
        function toggleMediatorSelection() {
            const role = document.getElementById('reg-role').value;
            const mediatorSelection = document.getElementById('mediator-selection');
            
            if (role === 'client') {
                mediatorSelection.classList.remove('hidden');
                loadAvailableMediators();
            } else {
                mediatorSelection.classList.add('hidden');
            }
        }

        function loadAvailableMediators() {
            const container = document.getElementById('mediator-checkboxes');
            const mediators = [
                { id: 'mediator1', name: 'Dr. Sarah Johnson', specialties: 'Property, Business, Commercial' },
                { id: 'mediator2', name: 'Michael Brown', specialties: 'Family, Employment, Community' },
                { id: 'mediator3', name: 'Lisa Chen', specialties: 'Property, Family, Commercial' },
                { id: 'mediator4', name: 'Robert Wilson', specialties: 'Business, Employment, Community' }
            ];

            container.innerHTML = mediators.map(mediator => `
                <div class="mediator-option">
                    <input type="checkbox" id="${mediator.id}" name="preferred-mediators" value="${mediator.id}">
                    <div class="mediator-info">
                        <div class="mediator-name">${mediator.name}</div>
                        <div class="mediator-specialties">${mediator.specialties}</div>
                    </div>
                </div>
            `).join('');
        }

        function loadCaseTypeFields() {
            const category = document.getElementById('case-category').value;
            const container = document.getElementById('case-type-fields-container');
            const fieldsContainer = document.getElementById('case-type-fields');
            const typeName = document.getElementById('case-type-name');
            const typeIcon = document.getElementById('case-type-icon');

            if (category && caseTypes[category]) {
                const caseType = caseTypes[category];
                typeName.textContent = `${caseType.name} - Required Information`;
                
                // Set appropriate icon based on case type
                const icons = {
                    'property': '🏠',
                    'business': '🏢',
                    'family': '👨‍👩‍👧‍👦',
                    'employment': '💼',
                    'community': '🏘️',
                    'commercial': '🤝'
                };
                typeIcon.textContent = icons[category] || '📋';

                fieldsContainer.innerHTML = caseType.fields.map(field => {
                    let input = '';
                    if (field.type === 'select') {
                        input = `
                            <select id="${field.id}" ${field.required ? 'required' : ''}>
                                <option value="">Select ${field.label}</option>
                                ${field.options.map(option => `<option value="${option}">${option}</option>`).join('')}
                            </select>
                        `;
                    } else if (field.type === 'textarea') {
                        input = `<textarea id="${field.id}" rows="3" ${field.required ? 'required' : ''} placeholder="Enter ${field.label.toLowerCase()}..."></textarea>`;
                    } else {
                        input = `<input type="${field.type}" id="${field.id}" ${field.required ? 'required' : ''} placeholder="Enter ${field.label.toLowerCase()}...">`;
                    }

                    return `
                        <div class="form-group">
                            <label for="${field.id}">${field.label} ${field.required ? '*' : ''}</label>
                            ${input}
                        </div>
                    `;
                }).join('');

                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        // Authentication functions
        function showAuthTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[onclick="showAuthTab('${tab}')"]`).classList.add('active');

            // Update forms
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.getElementById(`${tab}-form`).classList.add('active');
        }

        async function login(email, password) {
            try {
                console.log('Attempting login for:', email);
                
                let result;
                if (USE_LOCAL_STORAGE) {
                    console.log('Using local storage backend');
                    result = window.LSBackend.authenticateUser(email, password);
                } else {
                    console.log('API URL:', `${API_BASE_URL}/auth/login`);
                    
                    const response = await fetch(`${API_BASE_URL}/auth/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email, password })
                    });

                    console.log('Response status:', response.status);
                    console.log('Response ok:', response.ok);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    result = await response.json();
                }
                
                console.log('Login result:', result);
                
                if (result.success) {
                    currentUser = result.user;
                    userRole = result.user.role;
                    console.log('Login successful, user:', currentUser);
                    console.log('User role:', userRole);
                    
                    // Ensure dashboard shows - add a small delay to make sure DOM is ready
                    setTimeout(() => {
                        showDashboard();
                    }, 100);
                    
                    return true;
                } else {
                    console.log('Login failed:', result.error);
                    return false;
                }
            } catch (error) {
                console.error('Login error:', error);
                if (USE_LOCAL_STORAGE) {
                    alert(`Login failed: ${error.message}`);
                } else {
                    alert(`Login failed: ${error.message}. Please check if the API server is running at ${API_BASE_URL}`);
                }
                return false;
            }
        }

        async function register(formData) {
            try {
                const { name, email, role, password, organization, phone, preferred_mediators } = formData;
                
                let result;
                if (USE_LOCAL_STORAGE) {
                    console.log('Registering with local storage backend');
                    result = window.LSBackend.addUser({
                        email,
                        password,
                        full_name: name,
                        role,
                        organization,
                        phone,
                        preferred_mediators
                    });
                } else {
                    const response = await fetch(`${API_BASE_URL}/auth/register`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email,
                            password,
                            full_name: name,
                            role,
                            organization,
                            phone,
                            preferred_mediators
                        })
                    });

                    result = await response.json();
                }
                
                if (result.success) {
                    // Auto-login after successful registration
                    return await login(email, password);
                } else {
                    console.error('Registration failed:', result.error);
                    return false;
                }
            } catch (error) {
                console.error('Registration error:', error);
                return false;
            }
        }

        function showDashboard() {
            console.log('showDashboard called');
            console.log('currentUser:', currentUser);
            console.log('userRole:', userRole);
            
            // Hide auth section
            const authSection = document.getElementById('auth-section');
            const appSection = document.getElementById('app-section');
            
            console.log('Auth section:', authSection);
            console.log('App section:', appSection);
            
            authSection.classList.add('hidden');
            appSection.classList.remove('hidden');
            appSection.classList.add('active');

            // Update user info in header
            document.getElementById('user-name').textContent = currentUser.full_name || currentUser.name;
            const roleElement = document.getElementById('user-role');
            roleElement.textContent = userRole.charAt(0).toUpperCase() + userRole.slice(1);
            roleElement.className = `user-role role-${userRole}`;

            // Show appropriate dashboard
            if (userRole === 'mediator') {
                console.log('Showing mediator dashboard');
                document.getElementById('mediator-dashboard').classList.remove('hidden');
                loadMediatorDashboard();
            } else {
                console.log('Showing client dashboard');
                document.getElementById('client-dashboard').classList.remove('hidden');
                loadClientDashboard();
            }
            
            console.log('Dashboard setup complete');
        }

        function logout() {
            currentUser = null;
            userRole = null;
            document.getElementById('app-section').classList.add('hidden');
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('mediator-dashboard').classList.add('hidden');
            document.getElementById('client-dashboard').classList.add('hidden');
        }
        
        // Debug function to test dashboard display
        function testDashboard() {
            console.log('Testing dashboard display...');
            
            // Create test user data
            currentUser = {
                user_id: 'test-user-123',
                full_name: 'Test User',
                email: 'test@example.com',
                role: 'mediator'
            };
            userRole = 'mediator';
            
            console.log('Test user created:', currentUser);
            console.log('Test role:', userRole);
            
            // Try to show dashboard
            showDashboard();
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Dashboard loading functions
        function loadMediatorDashboard() {
            loadMediatorCases();
        }

        function loadClientDashboard() {
            loadClientCases();
            loadClientForms();
        }

        // Global case storage
        let userCases = [];
        let caseCounter = 1;

        async function loadMediatorCases() {
            try {
                let cases;
                if (USE_LOCAL_STORAGE) {
                    console.log('Loading cases from local storage');
                    cases = window.LSBackend.getCasesForUser(currentUser.user_id, userRole);
                } else {
                    const response = await fetch(`${API_BASE_URL}/cases?user_id=${currentUser.user_id}&role=${userRole}`);
                    const data = await response.json();
                    cases = data.success ? data.cases : [];
                }
                
                const casesContainer = document.getElementById('mediator-cases');
                
                if (!cases || cases.length === 0) {
                    casesContainer.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">📋</div>
                            <h3>No Cases Yet</h3>
                            <p>Create your first case to get started with mediation management.</p>
                            <button class="btn btn-primary" onclick="openModal('new-case-modal')" style="margin-top: 1rem;">Create First Case</button>
                        </div>
                    `;
                } else {
                    casesContainer.innerHTML = cases.map(caseItem => `
                        <div class="case-card">
                            <div class="case-header">
                                <div>
                                    <div class="case-title">${caseItem.title}</div>
                                    <div class="case-number">${caseItem.case_number}</div>
                                </div>
                                <span class="status-badge status-${caseItem.status}">${caseItem.status}</span>
                            </div>
                            <div class="case-description">${caseItem.description}</div>
                            <div class="case-meta">
                                <span>Category: ${caseItem.category}</span>
                                <span>Created: ${caseItem.created_at.split('T')[0]}</span>
                            </div>
                            <div class="case-actions">
                                <button class="btn btn-primary btn-sm" onclick="viewCase('${caseItem.case_id}')">View</button>
                                <button class="btn btn-secondary btn-sm" onclick="editCase('${caseItem.case_id}')">Edit</button>
                                <button class="btn btn-success btn-sm" onclick="assignClient('${caseItem.case_id}')">Assign Client</button>
                                <button class="btn btn-warning btn-sm" onclick="scheduleSession('${caseItem.case_id}')">Schedule Session</button>
                            </div>
                            <div class="case-actions-extended">
                                <button class="btn btn-export btn-sm" onclick="exportCaseData('${caseItem.case_id}')">Export</button>
                                <button class="btn btn-archive btn-sm" onclick="archiveCase('${caseItem.case_id}')">Archive</button>
                                <button class="btn btn-delete btn-sm" onclick="deleteCase('${caseItem.case_id}')">Delete</button>
                            </div>
                        </div>
                    `).join('');
                }
                
                // Update metrics
                updateMediatorMetrics(cases || []);
                
            } catch (error) {
                console.error('Error loading cases:', error);
                document.getElementById('mediator-cases').innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--error-color);">
                        <h3>Error Loading Cases</h3>
                        <p>Please refresh the page and try again.</p>
                    </div>
                `;
            }
        }

        function loadClientCases() {
            const casesContainer = document.getElementById('client-cases');
            
            // Filter cases where current user is assigned as a client
            const clientCases = userCases.filter(caseItem => 
                caseItem.assignedClients && caseItem.assignedClients.includes(currentUser.email)
            );
            
            if (clientCases.length === 0) {
                casesContainer.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">📋</div>
                        <h3>No Assigned Cases</h3>
                        <p>You haven't been assigned to any cases yet. Contact your mediator to get started.</p>
                    </div>
                `;
            } else {
                casesContainer.innerHTML = clientCases.map(caseItem => `
                    <div class="case-card">
                        <div class="case-header">
                            <div>
                                <div class="case-title">${caseItem.title}</div>
                                <div class="case-number">${caseItem.number}</div>
                            </div>
                            <span class="status-badge status-${caseItem.status}">${caseItem.status}</span>
                        </div>
                        <div class="case-description">${caseItem.description}</div>
                        <div class="case-meta">
                            <span>Mediator: ${caseItem.mediator}</span>
                            <span>Created: ${caseItem.created}</span>
                        </div>
                        <div class="case-actions">
                            <button class="btn btn-primary btn-sm" onclick="viewCase('${caseItem.id}')">View Details</button>
                            <button class="btn btn-secondary btn-sm" onclick="openClientCaseDetails('${caseItem.id}')">Complete Case Details</button>
                        </div>
                    </div>
                `).join('');
            }
            
            // Update metrics
            updateClientMetrics();
        }

        function loadClientForms() {
            const formsContainer = document.getElementById('client-forms');
            formsContainer.innerHTML = `
                <div class="info-collection">
                    <div class="info-section">
                        <h3 class="info-section-title">📋 Case #001 - Property Boundary Dispute</h3>
                        <p style="margin-bottom: 1rem; color: var(--text-secondary);">Please complete the following information to assist with your mediation case.</p>
                        
                        <div class="form-group">
                            <label>Your Position Statement</label>
                            <textarea rows="4" placeholder="Describe your position on the property boundary dispute..."></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Preferred Resolution</label>
                                <select>
                                    <option value="">Select preference</option>
                                    <option value="survey">Professional Survey</option>
                                    <option value="negotiation">Direct Negotiation</option>
                                    <option value="arbitration">Arbitration</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Timeline Preference</label>
                                <select>
                                    <option value="">Select timeline</option>
                                    <option value="urgent">As soon as possible</option>
                                    <option value="month">Within 1 month</option>
                                    <option value="quarter">Within 3 months</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Additional Information</label>
                            <textarea rows="3" placeholder="Any additional information that might be relevant..."></textarea>
                        </div>
                        
                        <div class="form-actions">
                            <button class="btn btn-primary">Submit Information</button>
                            <button class="btn btn-secondary">Save Draft</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function showUserManagement() {
            alert('User Management feature - would show user search, assignment, and management interface');
        }

        // Metrics update functions
        function updateMediatorMetrics(cases = []) {
            const activeCases = cases.filter(c => c.status === 'active').length;
            const resolvedCases = cases.filter(c => c.status === 'completed').length;
            const totalClients = cases.length; // Simplified for now
            
            document.getElementById('active-cases-count').textContent = activeCases;
            document.getElementById('resolved-cases-count').textContent = resolvedCases;
            document.getElementById('assigned-clients-count').textContent = totalClients;
            document.getElementById('sessions-today-count').textContent = '0'; // TODO: Implement session tracking
        }

        function updateClientMetrics() {
            const clientCases = userCases.filter(caseItem => 
                caseItem.assignedClients && caseItem.assignedClients.includes(currentUser.email)
            );
            
            document.getElementById('client-cases-count').textContent = clientCases.length;
            document.getElementById('upcoming-sessions-count').textContent = '0'; // TODO: Implement session tracking
            document.getElementById('pending-forms-count').textContent = '0'; // TODO: Implement form tracking
        }

        // Case management functions
        function viewCase(caseId) {
            const caseItem = userCases.find(c => c.id === caseId);
            if (!caseItem) {
                alert('Case not found');
                return;
            }

            const caseDetails = `
Case Details:
Title: ${caseItem.title}
Number: ${caseItem.number}
Status: ${caseItem.status}
Category: ${caseItem.category}
Description: ${caseItem.description}
Created: ${caseItem.created}
Mediator: ${caseItem.mediator}
Parties: ${caseItem.parties}
Assigned Clients: ${caseItem.assignedClients ? caseItem.assignedClients.join(', ') : 'None'}
            `;
            
            alert(caseDetails);
        }

        function editCase(caseId) {
            alert(`Editing Case #${caseId}`);
        }

        function assignClient(caseId) {
            // Populate case dropdown with actual cases
            const caseSelect = document.getElementById('assign-case');
            caseSelect.innerHTML = '<option value="">Select Case</option>';
            
            userCases.forEach(caseItem => {
                const option = document.createElement('option');
                option.value = caseItem.id;
                option.textContent = `${caseItem.number} - ${caseItem.title}`;
                if (caseItem.id === caseId) {
                    option.selected = true;
                }
                caseSelect.appendChild(option);
            });
            
            openModal('assign-client-modal');
        }

        function scheduleSession(caseId) {
            openModal('new-session-modal');
        }

        function submitInfo(caseId) {
            alert(`Submitting information for Case #${caseId}`);
        }

        // New advanced functions
        function exportCaseData(caseId) {
            openModal('export-data-modal');
            // Store case ID for export
            document.getElementById('export-data-modal').dataset.caseId = caseId;
        }

        function archiveCase(caseId) {
            openModal('archive-case-modal');
            // Store case ID for archiving
            document.getElementById('archive-case-modal').dataset.caseId = caseId;
        }

        function deleteCase(caseId) {
            const caseItem = userCases.find(c => c.id === caseId);
            if (!caseItem) {
                alert('Case not found');
                return;
            }
            
            if (confirm(`Are you sure you want to permanently delete "${caseItem.title}" (Case #${caseItem.number})? This action cannot be undone.`)) {
                // Remove from array
                userCases = userCases.filter(c => c.id !== caseId);
                alert(`Case #${caseItem.number} has been permanently deleted.`);
                loadMediatorCases(); // Refresh the list
            }
        }

        function openClientCaseDetails(caseId) {
            openModal('client-case-details-modal');
            
            // Load case information
            const caseInfo = document.getElementById('client-case-info');
            const caseFields = document.getElementById('client-case-fields');
            
            // Sample case data
            const caseData = {
                id: caseId,
                title: 'Property Boundary Dispute',
                number: 'CASE-001',
                category: 'property',
                description: 'Dispute between neighbors regarding property boundary lines and fence placement.',
                mediator: 'Dr. Sarah Johnson',
                created: '2024-01-15'
            };

            caseInfo.innerHTML = `
                <div class="case-type-fields">
                    <div class="case-type-title">
                        <span>🏠</span>
                        <span>Case Information</span>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Case Title</label>
                            <input type="text" value="${caseData.title}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Case Number</label>
                            <input type="text" value="${caseData.number}" readonly>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea rows="3" readonly>${caseData.description}</textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Assigned Mediator</label>
                            <input type="text" value="${caseData.mediator}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Case Created</label>
                            <input type="text" value="${caseData.created}" readonly>
                        </div>
                    </div>
                </div>
            `;

            // Load case-specific fields
            const caseType = caseTypes[caseData.category];
            if (caseType) {
                caseFields.innerHTML = `
                    <div class="case-type-fields">
                        <div class="case-type-title">
                            <span>📝</span>
                            <span>Complete Case Details</span>
                        </div>
                        ${caseType.fields.map(field => {
                            let input = '';
                            if (field.type === 'select') {
                                input = `
                                    <select id="client-${field.id}" ${field.required ? 'required' : ''}>
                                        <option value="">Select ${field.label}</option>
                                        ${field.options.map(option => `<option value="${option}">${option}</option>`).join('')}
                                    </select>
                                `;
                            } else if (field.type === 'textarea') {
                                input = `<textarea id="client-${field.id}" rows="3" ${field.required ? 'required' : ''} placeholder="Enter ${field.label.toLowerCase()}..."></textarea>`;
                            } else {
                                input = `<input type="${field.type}" id="client-${field.id}" ${field.required ? 'required' : ''} placeholder="Enter ${field.label.toLowerCase()}...">`;
                            }

                            return `
                                <div class="form-group">
                                    <label for="client-${field.id}">${field.label} ${field.required ? '*' : ''}</label>
                                    ${input}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
        }

        // Form handlers
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            // Show loading state
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Logging in...';
            submitButton.disabled = true;
            
            try {
                const success = await login(email, password);
                if (success) {
                    // Don't show alert - just proceed to dashboard
                    console.log('Login successful, proceeding to dashboard');
                    // Clear the form
                    this.reset();
                } else {
                    alert('Invalid email or password. Try: mediator@test.com or client1@test.com (password: password123)');
                    // Reset button state only on failure
                    submitButton.textContent = originalText;
                    submitButton.disabled = false;
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Please check if the API server is running.');
                // Reset button state on error
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            }
        });

        document.getElementById('register-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = {
                name: document.getElementById('reg-name').value,
                email: document.getElementById('reg-email').value,
                organization: document.getElementById('reg-organization').value,
                phone: document.getElementById('reg-phone').value,
                role: document.getElementById('reg-role').value,
                password: document.getElementById('reg-password').value
            };
            
            if (formData.password !== document.getElementById('reg-confirm').value) {
                alert('Passwords do not match!');
                return;
            }
            
            // Get preferred mediators if client
            const preferredMediators = [];
            if (formData.role === 'client') {
                const mediatorCheckboxes = document.querySelectorAll('input[name="preferred-mediators"]:checked');
                mediatorCheckboxes.forEach(checkbox => {
                    preferredMediators.push(checkbox.value);
                });
            }
            formData.preferred_mediators = preferredMediators;
            
            // Show loading state
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Registering...';
            submitButton.disabled = true;
            
            try {
                const success = await register(formData);
                if (success) {
                    alert('Registration successful!');
                } else {
                    alert('Registration failed. Please try again.');
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('Registration failed. Please check if the API server is running.');
            } finally {
                // Reset button state
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            }
        });

        document.getElementById('new-case-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                // Get form data
                const title = document.getElementById('case-title').value;
                const description = document.getElementById('case-description').value;
                const category = document.getElementById('case-category').value;
                const priority = document.getElementById('case-priority').value;
                const mediator = document.getElementById('case-mediator').value;
                
                // Collect case type specific fields
                const caseDetails = {};
                if (category && caseTypes[category]) {
                    caseTypes[category].fields.forEach(field => {
                        const element = document.getElementById(field.id);
                        if (element) {
                            caseDetails[field.id] = element.value;
                        }
                    });
                }
                
                // Create case
                let result;
                if (USE_LOCAL_STORAGE) {
                    console.log('Creating case with local storage backend');
                    result = window.LSBackend.createCase({
                        title,
                        description,
                        category,
                        priority,
                        assigned_mediator_id: currentUser.user_id, // Current user is the mediator
                        created_by: currentUser.user_id,
                        case_details: caseDetails
                    });
                } else {
                    const response = await fetch(`${API_BASE_URL}/cases`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            title,
                            description,
                            category,
                            priority,
                            assigned_mediator_id: currentUser.user_id, // Current user is the mediator
                            created_by: currentUser.user_id,
                            case_details: caseDetails
                        })
                    });
                    
                    result = await response.json();
                }
                
                if (result.success) {
                    alert(`New case created successfully! Case ID: ${result.case_id}`);
                    closeModal('new-case-modal');
                    this.reset();
                    
                    // Hide case type fields
                    document.getElementById('case-type-fields-container').classList.add('hidden');
                    
                    // Reload cases
                    loadMediatorCases();
                } else {
                    alert(`Error creating case: ${result.error}`);
                }
                
            } catch (error) {
                console.error('Error creating case:', error);
                alert('Error creating case. Please try again.');
            }
        });

        document.getElementById('assign-client-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const caseId = document.getElementById('assign-case').value;
            const clientEmail = document.getElementById('assign-client').value;
            const clientRole = document.getElementById('client-role').value;
            
            // Find the case
            const caseItem = userCases.find(c => c.id === caseId);
            if (!caseItem) {
                alert('Case not found');
                return;
            }
            
            // Add client to case
            if (!caseItem.assignedClients) {
                caseItem.assignedClients = [];
            }
            
            if (!caseItem.assignedClients.includes(clientEmail)) {
                caseItem.assignedClients.push(clientEmail);
                caseItem.parties = caseItem.assignedClients.length;
                
                alert(`Client assigned successfully to Case #${caseItem.number}!`);
                loadMediatorCases(); // Refresh the list
            } else {
                alert('Client is already assigned to this case');
            }
            
            closeModal('assign-client-modal');
            this.reset();
        });

        document.getElementById('new-session-form').addEventListener('submit', function(e) {
            e.preventDefault();
            alert('Mediation session scheduled successfully!');
            closeModal('new-session-modal');
            this.reset();
        });

        // Archive case form handler
        document.getElementById('archive-case-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const modal = document.getElementById('archive-case-modal');
            const caseId = modal.dataset.caseId;
            const action = document.querySelector('input[name="archive-action"]:checked').value;
            const reason = document.getElementById('archive-reason').value;
            
            try {
                let result;
                if (action === 'archive') {
                    if (USE_LOCAL_STORAGE) {
                        console.log('Archiving case with local storage backend');
                        result = window.LSBackend.archiveCase(caseId, currentUser.user_id, reason);
                    } else {
                        const response = await fetch(`${API_BASE_URL}/cases/${caseId}/archive`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                archived_by: currentUser.user_id,
                                reason: reason
                            })
                        });
                        
                        result = await response.json();
                    }
                    
                    if (result.success) {
                        alert(`Case has been archived. Reason: ${reason}`);
                    } else {
                        alert(`Error archiving case: ${result.error}`);
                    }
                } else {
                    if (USE_LOCAL_STORAGE) {
                        console.log('Deleting case with local storage backend');
                        result = window.LSBackend.deleteCase(caseId, currentUser.user_id, reason);
                    } else {
                        const response = await fetch(`${API_BASE_URL}/cases/${caseId}/delete`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                deleted_by: currentUser.user_id,
                                reason: reason
                            })
                        });
                        
                        result = await response.json();
                    }
                    
                    if (result.success) {
                        alert(`Case has been permanently deleted. Reason: ${reason}`);
                    } else {
                        alert(`Error deleting case: ${result.error}`);
                    }
                }
                
                closeModal('archive-case-modal');
                this.reset();
                loadMediatorCases(); // Refresh the list
                
            } catch (error) {
                console.error('Archive/Delete error:', error);
                alert('Error processing request. Please try again.');
            }
        });

        // Export data form handler
        document.getElementById('export-data-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const modal = document.getElementById('export-data-modal');
            const caseId = modal.dataset.caseId;
            const format = document.getElementById('export-format').value;
            const selectedData = Array.from(document.querySelectorAll('input[name="export-data"]:checked')).map(cb => cb.value);
            
            try {
                let result;
                if (USE_LOCAL_STORAGE) {
                    console.log('Exporting case data with local storage backend');
                    result = window.LSBackend.exportCaseDataToCSV(caseId, {
                        'case-details': selectedData.includes('case-details'),
                        'client-info': selectedData.includes('client-info'),
                        'case-logs': selectedData.includes('case-logs'),
                        'documents': selectedData.includes('documents')
                    });
                } else {
                    const response = await fetch(`${API_BASE_URL}/cases/${caseId}/export`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            export_options: {
                                'case-details': selectedData.includes('case-details'),
                                'client-info': selectedData.includes('client-info'),
                                'case-logs': selectedData.includes('case-logs'),
                                'documents': selectedData.includes('documents')
                            }
                        })
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `case-${caseId}-export.csv`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        
                        alert(`Case data exported successfully in ${format.toUpperCase()} format!`);
                        closeModal('export-data-modal');
                        this.reset();
                        return;
                    } else {
                        const errorData = await response.json();
                        alert(`Error exporting data: ${errorData.error}`);
                        return;
                    }
                }
                
                if (result.success) {
                    // Create and download CSV file
                    const blob = new Blob([result.csv_data], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `case-${caseId}-export.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    alert(`Case data exported successfully in ${format.toUpperCase()} format!`);
                    closeModal('export-data-modal');
                    this.reset();
                } else {
                    alert(`Error exporting data: ${result.error}`);
                }
                
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting data. Please try again.');
            }
        });

        // Client case details form handler
        document.getElementById('client-case-details-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Collect form data
            const formData = new FormData(this);
            const caseData = {};
            
            // Get all case-specific fields
            document.querySelectorAll('#client-case-fields input, #client-case-fields select, #client-case-fields textarea').forEach(field => {
                caseData[field.id.replace('client-', '')] = field.value;
            });
            
            // Get visibility settings
            const visibility = {
                mediator: true, // Always visible to mediator
                otherParties: document.getElementById('visible-to-other-parties').checked,
                support: document.getElementById('visible-to-support').checked
            };
            
            alert('Case details submitted successfully! Your information has been saved and shared according to your visibility preferences.');
            closeModal('client-case-details-modal');
            this.reset();
        });

        // Close modal when clicking outside
        window.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });

        // CSV Export functionality
        function generateCSVData(caseId, selectedData) {
            const caseData = {
                id: caseId,
                title: 'Property Boundary Dispute',
                number: 'CASE-001',
                status: 'active',
                category: 'property',
                description: 'Dispute between neighbors regarding property boundary lines and fence placement.',
                mediator: 'Dr. Sarah Johnson',
                created: '2024-01-15',
                parties: [
                    { name: 'John Smith', email: 'john@example.com', role: 'Primary Party', phone: '555-0123' },
                    { name: 'Jane Doe', email: 'jane@example.com', role: 'Secondary Party', phone: '555-0456' }
                ],
                sessions: [
                    { date: '2024-01-20', type: 'Joint Session', duration: '2 hours', status: 'Completed' },
                    { date: '2024-01-25', type: 'Individual Session', duration: '1 hour', status: 'Scheduled' }
                ],
                documents: [
                    { name: 'Property Survey', type: 'PDF', uploaded: '2024-01-16' },
                    { name: 'Legal Correspondence', type: 'PDF', uploaded: '2024-01-18' }
                ]
            };

            let csvContent = '';
            let headers = [];
            let rows = [];

            if (selectedData.includes('case-details')) {
                headers.push('Case ID', 'Title', 'Number', 'Status', 'Category', 'Description', 'Mediator', 'Created');
                rows.push([
                    caseData.id,
                    caseData.title,
                    caseData.number,
                    caseData.status,
                    caseData.category,
                    `"${caseData.description}"`,
                    caseData.mediator,
                    caseData.created
                ]);
            }

            if (selectedData.includes('client-info')) {
                headers.push('Party Name', 'Email', 'Phone', 'Role');
                caseData.parties.forEach(party => {
                    rows.push([
                        party.name,
                        party.email,
                        party.phone,
                        party.role
                    ]);
                });
            }

            if (selectedData.includes('case-logs')) {
                headers.push('Session Date', 'Type', 'Duration', 'Status');
                caseData.sessions.forEach(session => {
                    rows.push([
                        session.date,
                        session.type,
                        session.duration,
                        session.status
                    ]);
                });
            }

            if (selectedData.includes('documents')) {
                headers.push('Document Name', 'Type', 'Uploaded');
                caseData.documents.forEach(doc => {
                    rows.push([
                        doc.name,
                        doc.type,
                        doc.uploaded
                    ]);
                });
            }

            csvContent = headers.join(',') + '\n';
            rows.forEach(row => {
                csvContent += row.join(',') + '\n';
            });

            return csvContent;
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Initialize
        console.log('Unified Mediation Platform loaded');
    </script>
</body>
</html>